<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js\AvatarWizard.js - Avatar Wizard</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Avatar Wizard"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AvatarWizard.html">AvatarWizard</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: js\AvatarWizard.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Manages the composition of a user avatar using predefined graphic parts. This
 * class requires jQuery.
 *
 * The constructor needs to fetch a &#x60;settings.json&#x60; file through AJAX and its
 * methods may not be invoked until this has been done. The user-defined &#x60;ready&#x60;
 * callback is invoked by the &#x60;AvatarWizard&#x60; object when it is ready.
 *
 * The &#x60;settings.json&#x60; file must have the following format:
 *
 *	{
 *		&quot;canonicalWidth&quot;: 123,
 *		&quot;canonicalHeight&quot;: 456,
 *		&quot;thumbnails&quot;: {
 *			&quot;config1&quot;: {
 *				&quot;layers&quot;: [
 *					&quot;category1&quot;,
 *					&quot;category2&quot;,
 *					&quot;category3&quot;,
 *					...
 *				],
 *				&quot;area&quot;: {
 *					&quot;x&quot;: 10,
 *					&quot;y&quot;: 10,
 *					&quot;width&quot;: 80,
 *					&quot;height&quot;: 400
 *				}
 *			},
 *			&quot;config2&quot;: {
 *				&quot;layers&quot;: [
 *					&quot;category3&quot;,
 *					&quot;category4&quot;,
 *					&quot;category5&quot;,
 *					...
 *				],
 *				&quot;area&quot;: {
 *					&quot;x&quot;: 10,
 *					&quot;y&quot;: 10,
 *					&quot;width&quot;: 80,
 *					&quot;height&quot;: 400
 *				}
 *			},
 *			...
 *		},
 *		&quot;path&quot;: &quot;path/to/parts&quot;,
 *		&quot;parts&quot;: {
 *			&quot;category1&quot;: [
 *				&quot;type1&quot;,
 *				&quot;type2&quot;,
 *				...
 *			],
 *			&quot;category2&quot;: [
 *				&quot;type1&quot;,
 *				&quot;type2&quot;,
 *				...
 *			],
 *			&quot;category3&quot;: [
 *				.
 *				.
 *				.
 *			],
 *		},
 *		&quot;layers&quot;: [
 *			&quot;category1&quot;,
 *			&quot;category2&quot;,
 *			&quot;category3&quot;,
 *			...
 *		]
 *	}
 *
 * &#x60;canonicalWidth&#x60; and &#x60;canonicalHeight&#x60; are the dimensions of a rectangular
 * area the coordinates in the js image files refer to. Modifying these
 * parameters influences the size of the avatar relative to the destination
 * canvas.
 *
 * TODO document &#x60;thumbnails&#x60;
 *
 * &#x60;path&#x60; is the path of the directory tree containing the js image files. The
 * directory represented by &#x60;path&#x60; must contain one subdirectory for each
 * category; each category directory must in turn contain one &#x60;.js&#x60; file for
 * each part/type.
 *
 * &quot;parts&quot; is the set of registered parts and categories. The &quot;parts&quot; object
 * maps category names to part arrays (each key is a category name and its value
 * is an array of part names).
 *
 * &quot;layers&quot; specifies the order in which the several parts are drawn to the
 * canvas; it is an array of category names.
 *
 * TODO document &#x60;exclusions&#x60;
 *
 * The full path of a part is build as follows:
 *
 *	path/category/part.json
 *
 * which means that the &quot;path&quot; option is prepended, the category name follows,
 * the part name follows and the &#x60;.json&#x60; file extension is appended.
 *
 * @class AvatarWizard
 * @constructor
 * @param canvas Mixed Specifies the HTML5 canvas where the avatar has to be
 * drawn. It can be specified as a HTMLCanvasElement object, string CSS selector
 * or jQuery object.
 * @param ready Function A user-defined callback function invoked after the
 * &#x60;AvatarWizard&#x60; object has read its configuration file and its ready to
 * receive method invocations.
 * @param [progress] Function An optional user-defined callback function invoked
 * several times as the &#x60;AvatarWizard&#x60; object loads configuration settings and
 * part files.
 * @param progress.progress Number A percentage value indicating the progress in
 * a &#x60;[0, 100)&#x60; range.
 */
function AvatarWizard(canvas, ready, progress) {
	var thisObject = this;

	var functions = {};
	var descriptor = {};

	$.getJSON(&#x27;settings.json&#x27;, function (settings) {
		if (!/\/$/.test(settings.path)) {
			settings.path += &#x27;/&#x27;;
		}

		var layers = settings.layers;
		var exclusions = settings.exclusions;

		function Renderer(canvas, settings) {
			var thisObject = this;

			var layerMask = [];

			function resetLayerMask() {
				layerMask = layers.map(function () {
					return true;
				});
				exclusions.forEach(function (exclusion) {
					if (descriptor.hasOwnProperty(exclusion.category) &amp;&amp;
						(!exclusion.hasOwnProperty(&#x27;type&#x27;) ||
						(descriptor[exclusion.category] == exclusion.type)))
					{
						layers.forEach(function (category, index) {
							if (exclusion.excludes.indexOf(category) &gt;= 0) {
								layerMask[index] = false;
							}
						});
					}
				});
				return thisObject;
			}

			resetLayerMask();

			canvas = $(canvas);
			var context = canvas[0].getContext(&#x27;2d&#x27;);
			var width, height;
			var drawing = false;

			function setDimensions() {
				if (canvas.parent().length) {
					width = canvas.innerWidth();
					height = canvas.innerHeight();
					canvas.attr({
						width: width,
						height: height
					});
				} else {
					width = parseInt(canvas.attr(&#x27;width&#x27;), 10);
					height = parseInt(canvas.attr(&#x27;height&#x27;), 10);
				}
				context.setTransform(1, 0, 0, 1, 0, 0);
				if (settings.stretch) {
					context.scale(width / settings.width, height / settings.height);
				} else {
					var ratio1 = width / settings.width;
					var ratio2 = height / settings.height;
					if (ratio2 &lt; ratio1) {
						context.translate((width - settings.width * ratio2) / 2, 0);
						context.scale(ratio2, ratio2);
					} else {
						context.translate(0, (height - settings.height * ratio1) / 2);
						context.scale(ratio1, ratio1);
					}
				}
				context.translate(-settings.x, -settings.y);
				return thisObject;
			}

			setDimensions();

			function drawElement(category) {
				if (descriptor.hasOwnProperty(category)) {
					if (typeof descriptor[category] !== &#x27;string&#x27;) {
						functions[category + &#x27;/&#x27; + descriptor[category].type](context, descriptor[category].color);
					} else {
						functions[category + &#x27;/&#x27; + descriptor[category]](context);
					}
					return true;
				} else {
					return false;
				}
			}

			function drawAll() {
				context.save();
				context.setTransform(1, 0, 0, 1, 0, 0);
				context.clearRect(0, 0, width, height);
				context.restore();
				for (var i = 0; i &lt; layers.length; i++) {
					if (layerMask[i]) {
						drawElement(layers[i]);
					}
				}
				drawing = false;
				return thisObject;
			}

			function issue() {
				if (!drawing) {
					requestAnimationFrame(drawAll);
				}
				return thisObject;
			}

			this.drawAll = drawAll;
			this.issue = issue;

			this.setDimensions = function () {
				setDimensions();
				issue();
				return thisObject;
			};

			this.resetLayerMask = resetLayerMask;

			this.maskIn = function (names) {
				if (!Array.isArray(names)) {
					names = [names];
				}
				layers.forEach(function (name, index) {
					if (names.indexOf(name) &lt; 0) {
						layerMask[index] = false;
					}
				});
				return thisObject;
			};
		}

		var renderer = new Renderer(canvas, {
			stretch: false,
			x: 0,
			y: 0,
			width: settings.canonicalWidth,
			height: settings.canonicalHeight
		});

		(function (total) {
			var count = 0;
			function fetchPart(name) {
				$.get(settings.path + name + &#x27;.js&#x27;, function (code) {
					eval(code);
					functions[name] = draw;
					if (++count &lt; total) {
						if (progress) {
							progress(Math.round(count * 100 / total));
						}
					} else {
						renderer.resetLayerMask().issue();
						ready();
					}
				}, &#x27;text&#x27;);
			}
			for (var category in settings.parts) {
				if (settings.parts.hasOwnProperty(category)) {
					settings.parts[category].forEach(function (image) {
						fetchPart(category + &#x27;/&#x27; + image);
					});
				}
			}
		})(0);

		/**
		 * Recalculates the coordinate reference. This method must be invoked
		 * every time the dimensions of the canvas change.
		 *
		 * This method may be called in response to &#x60;resize&#x60; events at a high
		 * rate because the redraw rate is throttled down through
		 * &#x60;requestAnimationFrame&#x60;.
		 *
		 * @method resetDimensions
		 * @chainable
		 */
		thisObject.resetDimensions = function () {
			renderer.setDimensions();
			return thisObject;
		};

		/**
		 * Loads the avatar described by the specified JSON object and updates
		 * the rendering on the canvas.
		 *
		 * The specified object must have the following format:
		 *
		 *	{
		 *		&quot;category1&quot;: &quot;type3&quot;,
		 *		&quot;category2&quot;: {
		 *			&quot;type&quot;: &quot;type2&quot;,
		 *			&quot;color&quot;: &quot;#abcdef&quot;
		 *		},
		 *		&quot;category3&quot;: {
		 *			&quot;type&quot;: &quot;type1&quot;,
		 *			&quot;color&quot;: &quot;rgb(12, 34, 56)&quot;
		 *		},
		 *		.
		 *		.
		 *		.
		 *	}
		 *
		 * Each key must be a valid category name (one registered in the
		 * &#x60;settings.json&#x60; file, as documented in the
		 * {{#crossLink &quot;AvatarWizard&quot;}}AvatarWizard constructor{{/crossLink}})
		 * and its value can be either a string (a valid part/type name
		 * registered for that category) or an object; in the latter case it
		 * contains a mandatory &#x60;type&#x60; field specifying the part/type name and
		 * an optional &#x60;color&#x60; field specifying a CSS color for the part.
		 *
		 * Note that the specified JSON object is deep-copied, so subsequent
		 * modifications to it do not have any effect on the avatar managed by
		 * this object. To modify the managed avatar use the
		 * {{#crossLink &quot;AvatarWizard/select&quot;}}select{{/crossLink}} method.
		 *
		 * @method loadAvatar
		 * @chainable
		 * @param newDescriptor Object A JSON object describing the avatar to
		 * load.
		 */
		thisObject.loadAvatar = function (newDescriptor) {
			descriptor = $.extend({}, newDescriptor);
			renderer.resetLayerMask().issue();
			return thisObject;
		};

		/**
		 * Returns a JSON object that describes the current avatar as modified
		 * by {{#crossLink &quot;AvatarWizard/loadAvatar&quot;}}loadAvatar{{/crossLink}}
		 * and {{#crossLink &quot;AvatarWizard/select&quot;}}select{{/crossLink}} calls.
		 *
		 * See {{#crossLink &quot;AvatarWizard/loadAvatar&quot;}}loadAvatar{{/crossLink}}
		 * for information about the JSON format of avatar descriptors.
		 *
		 * The returned object is a deep copy of the object mainatined
		 * internally by the AvatarWizard instance.
		 *
		 * @method getAvatar
		 * @return Object A JSON object that describes the current avatar.
		 */
		thisObject.getAvatar = function () {
			return $.extend({}, descriptor);
		};

		/**
		 * Returns the currently selected part type for the specified category,
		 * or &#x60;undefined&#x60; if no part is selected.
		 *
		 * Parts can be selected per-category using the
		 * {{#crossLink &quot;AvatarWizard/select&quot;}}select{{/crossLink}} method.
		 *
		 * @method getSelected
		 * @param category String A category name.
		 * @return String The selected part type, or &#x60;undefined&#x60; if no part is
		 * selected for the specified category.
		 */
		thisObject.getSelected = function (category) {
			if (typeof descriptor[category] === &#x27;string&#x27;) {
				return descriptor[category];
			} else if (typeof descriptor[category] === &#x27;object&#x27;) {
				return descriptor[category].type;
			}
		};

		/**
		 * Selects the specified part for the specified category and updates the
		 * rendering of the avatar on the canvas.
		 *
		 * Both the category and part/type names must be valid names registered
		 * in the &#x60;settings.json&#x60; file, as explained in the
		 * {{#crossLink &quot;AvatarWizard&quot;}}AvatarWizard constructor{{/crossLink}}.
		 *
		 * To remove a currently selected part, invoke &#x60;select&#x60; for its category
		 * without specifying the &#x60;type&#x60; argument.
		 *
		 * @method select
		 * @chainable
		 * @param category String The category the part is being selected for.
		 * @param [type] String The part name. If not specified, the part is
		 * removed.
		 * @example
		 *	wizard.select(&#x27;hair&#x27;, &#x27;blonde1&#x27;);
		 */
		thisObject.select = function (category, type) {
			if (typeof type !== &#x27;undefined&#x27;) {
				type += &#x27;&#x27;;
				if (functions.hasOwnProperty(category + &#x27;/&#x27; + type)) {
					if (descriptor.hasOwnProperty(category)) {
						if (typeof descriptor[category] !== &#x27;string&#x27;) {
							descriptor[category].type = type;
						} else {
							descriptor[category] = type;
						}
					} else {
						descriptor[category] = type;
					}
					renderer.resetLayerMask().issue();
				} else {
					throw &#x27;Unregistered category or image ID: &quot;&#x27; + category + &#x27;&quot;, &quot;&#x27; + type + &#x27;&quot;&#x27;;
				}
			} else {
				delete descriptor[category];
				renderer.resetLayerMask().issue();
			}
			return thisObject;
		};

		/**
		 * Returns the current color for the specified category.
		 *
		 * This value can be set per-category with the
		 * {{#crossLink &quot;AvatarWizard/setColor&quot;}}setColor{{/crossLink}} method
		 * or in the avatar descriptor specified to the
		 * {{#crossLink &quot;AvatarWizard/loadAvatar&quot;}}loadAvatar{{/crossLink}}
		 * method.
		 *
		 * The return value is undefined if no color has been set.
		 *
		 * @method getColor
		 * @param category String The category to set the color for.
		 * @return String The current CSS color for the specified category, or
		 * &#x60;undefined&#x60; if no color is set.
		 */
		thisObject.getColor = function (category) {
			if (descriptor.hasOwnProperty(category)) {
				if (typeof descriptor[category] !== &#x27;string&#x27;) {
					return descriptor[category].color;
				}
			}
		};

		/**
		 * Sets the color of the currently selected part for the specified
		 * category.
		 *
		 * @method setColor
		 * @chainable
		 * @param category String A category name.
		 * @param color String A CSS color value.
		 */
		thisObject.setColor = function (category, color) {
			if (descriptor.hasOwnProperty(category)) {
				if (typeof descriptor[category] !== &#x27;string&#x27;) {
					descriptor[category].color = color;
				} else {
					descriptor[category] = {
						type: descriptor[category],
						color: color
					};
				}
			}
			renderer.issue();
			return thisObject;
		};

		function getThumbnail(width, height, thumbnailSettings) {
			if (!settings.thumbnails.hasOwnProperty(thumbnailSettings.configName)) {
				throw &#x27;Invalid thumbnail configuration name&#x27;;
			}
			var config = settings.thumbnails[thumbnailSettings.configName];
			var canvas = document.createElement(&#x27;canvas&#x27;);
			canvas.width = width;
			canvas.height = height;
			var renderer = new Renderer(canvas, {
				stretch: !!thumbnailSettings.stretch,
				x: config.area.x,
				y: config.area.y,
				width: config.area.width,
				height: config.area.height
			});
			renderer.maskIn(config.layers).drawAll();
			return canvas;
		}

		/**
		 * Returns an HTMLElement of the specified width and height containing a
		 * prerendered thumbnail of the avatar.
		 *
		 * The exact type of HTML element is left unspecified: it may be an
		 * image element as well as a canvas.
		 *
		 * @method getThumbnail
		 * @param width Number The width of the thumbnail to generate.
		 * @param height Number The height of the thumbnail to generate.
		 * @param settings Object Thumbnail generation settings.
		 * @param [settings.stretch=false] Boolean Indicates whether the avatar
		 * must be stretched to fit the specified width and height exactly.
		 * &#x60;false&#x60; indicates that the avatar&#x27;s proportions are maintained.
		 * @param settings.configName String The thumbnail configuration to use.
		 * It must be the name of a valid thumbnail configuration registered in
		 * the &#x60;thumbnails&#x60; field of the &#x60;settings.json&#x60; file.
		 *
		 * See the
		 * {{#crossLink &quot;AvatarWizard&quot;}}AvatarWizard constructor{{/crossLink}}
		 * for more information.
		 * @return HTMLElement An HTML element of the specified dimensions
		 * containing a prerendered avatar.
		 */
		thisObject.getThumbnail = getThumbnail;

		/**
		 * Returns a data URI that encodes a PNG prerendered image of the
		 * avatar of the specified width and height.
		 *
		 * @method getEncodedThumbnail
		 * @param width Number The width of the image to generate.
		 * @param height Number The height of the image to generate.
		 * @param settings Object Thumbnail generation settings.
		 * @param [settings.stretch=false] Boolean Indicates whether the avatar
		 * must be stretched to fit the specified width and height exactly.
		 * &#x60;false&#x60; indicates that the avatar&#x27;s proportions are maintained.
		 * @param settings.configName String The thumbnail configuration to use.
		 * It must be the name of a valid thumbnail configuration registered in
		 * the &#x60;thumbnails&#x60; field of the &#x60;settings.json&#x60; file.
		 *
		 * See the
		 * {{#crossLink &quot;AvatarWizard&quot;}}AvatarWizard constructor{{/crossLink}}
		 * for more information.
		 * @return String A data URI that encodes the generated image in PNG
		 * format.
		 */
		thisObject.getEncodedThumbnail = function (width, height, settings) {
			return getThumbnail(width, height, settings).toDataURL(&#x27;image/png&#x27;);
		};
	});
}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
